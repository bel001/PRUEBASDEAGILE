<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agile Pr√©stamos - Sistema de Cobranzas</title>
    <link rel="stylesheet" href="Style.css">
    <!-- jsPDF para generar comprobantes PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="toast-container"></div>

    <!-- PANTALLA DE LOGIN -->
    <div id="pantalla-login" class="login-overlay" style="display: flex;">
        <div class="login-card">
            <h1>üè¶ AGILE Pr√©stamos</h1>
            <h3>Sistema de Cobranzas</h3>
            <p style="color: #7f8c8d; margin-bottom: 30px;">Inicio de Sesi√≥n - Cajero</p>

            <div class="form-group">
                <label>Usuario:</label>
                <input type="text" id="login-usuario" placeholder="Ingrese su usuario" value="cajero">
            </div>

            <div class="form-group">
                <label>Contrase√±a:</label>
                <input type="password" id="login-password" placeholder="Ingrese su contrase√±a" value="123">
            </div>

            <div id="login-mensaje" style="color: #e74c3c; text-align: center; margin: 10px 0;"></div>

            <button class="btn-secondary" style="width: 100%; padding: 12px;" onclick="iniciarSesion()">
                üîê Iniciar Sesi√≥n
            </button>

            <small style="display: block; text-align: center; margin-top: 15px; color: #95a5a6;">
                Usuario demo: <strong>cajero</strong> / Contrase√±a: <strong>123</strong>
            </small>
        </div>
    </div>

    <!-- APLICACI√ìN PRINCIPAL -->
    <div id="app-principal" style="display: none;">
        <div class="container">
            <header>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1>üè¶ Agile Pr√©stamos</h1>
                        <p>Sistema de Gesti√≥n de Cobranzas y Caja</p>
                    </div>
                    <div style="text-align: right;">
                        <span id="nombre-cajero"
                            style="font-weight: bold; padding: 5px 15px; background: #e0e0e0; border-radius: 20px; font-size: 0.9em;">üë§
                            Cajero</span>
                        <button onclick="cerrarSesion()" class="btn-small"
                            style="background: #e74c3c; margin-left: 10px;">Salir</button>
                    </div>
                </div>
            </header>

            <nav>
                <button class="nav-btn active" onclick="mostrarSeccion('clientes')">üë• Clientes</button>
                <button class="nav-btn" onclick="mostrarSeccion('prestamos')">üí∞ Pr√©stamos</button>
                <button class="nav-btn" onclick="mostrarSeccion('pagos')">üí≥ Cobranza</button>
                <button class="nav-btn" onclick="mostrarCaja()">üè¶ Caja</button>
                <button class="nav-btn" onclick="mostrarSeccion('empleados')">üë• Empleados</button>
            </nav>

            <!-- SECCI√ìN CLIENTES -->
            <div id="seccion-clientes" class="seccion">

                <!-- Estad√≠sticas de Filtro (Oculto por defecto) -->
                <div id="stats-morosos" class="filter-stats" style="display: none;">
                    <span>‚ö†Ô∏è Mostrando solo clientes con cuotas vencidas</span>
                    <span id="total-mora-acumulada">Total Mora: S/ 0.00</span>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Nuevo Cliente</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Tipo de Documento:</label>
                            <select id="tipo">
                                <option value="NATURAL">DNI (Persona)</option>
                                <option value="JURIDICA">RUC (Empresa)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>N√∫mero de Documento:</label>
                            <div class="input-group">
                                <input type="text" id="documento" placeholder="Ej: 72345678" maxlength="11">
                                <button class="btn-secondary" onclick="crearCliente()">üîç Buscar y Guardar</button>
                            </div>
                            <small>El sistema buscar√° el nombre autom√°ticamente en RENIEC/SUNAT.</small>
                        </div>

                        <div id="mensaje" class="mensaje"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>üìã Listado de Clientes</h3>
                        <button id="btn-filtro-morosos" class="btn-filter" onclick="toggleFiltroMorosos()">
                            ‚ö†Ô∏è Ver Solo Morosos
                        </button>
                        <button class="btn-small" onclick="cargarClientes()" style="margin-left: 10px;">üîÑ
                            Actualizar</button>
                        <button class="btn-small" onclick="exportarClientesCSV()"
                            style="margin-left: 10px; background: #27ae60;">üì• Exportar CSV</button>
                    </div>
                    <div class="card-body">
                        <table class="tabla-clientes">
                            <thead>
                                <tr>
                                    <th>Documento</th>
                                    <th>Nombre / Raz√≥n Social</th>
                                    <th>Tipo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="listaClientes">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN PR√âSTAMOS -->
            <div id="seccion-prestamos" class="seccion" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h3>Nuevo Pr√©stamo</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Buscar Cliente por Documento o Nombre:</label>
                            <div class="input-group">
                                <input type="text" id="buscar-cliente-doc" placeholder="Ingrese DNI, RUC o Nombre">
                                <button class="btn-secondary" onclick="buscarClienteParaPrestamo()">üîç Buscar</button>
                            </div>
                        </div>

                        <div id="info-cliente"
                            style="display:none; padding: 15px; background: #e8f5e9; border-radius: 5px; margin-bottom: 15px;">
                            <p style="margin: 5px 0;"><strong>Cliente:</strong> <span id="cliente-nombre"></span></p>
                            <p style="margin: 5px 0;"><strong>Documento:</strong> <span id="cliente-doc"></span></p>
                        </div>

                        <div id="form-prestamo" style="display:none;">
                            <div class="form-group">
                                <label>Monto Total del Pr√©stamo:</label>
                                <input type="number" id="monto-prestamo" placeholder="Ej: 5000" step="0.01" max="20000">
                                <small>M√°ximo: S/ 20,000</small>
                            </div>

                            <div class="form-group">
                                <label>N√∫mero de Cuotas:</label>
                                <input type="number" id="num-cuotas" placeholder="Ej: 12" min="1" max="24">
                                <small>M√°ximo: 24 cuotas</small>
                            </div>

                            <button class="btn-secondary" style="width: 100%; padding: 12px;" onclick="crearPrestamo()">
                                üí∞ Crear Pr√©stamo
                            </button>
                        </div>

                        <div id="mensaje-prestamo" class="mensaje"></div>
                    </div>
                </div>

                <div class="card" id="detalle-prestamo-card" style="display:none;">
                    <div class="card-header">
                        <h3>Pr√©stamo Activo</h3>
                        <button class="btn-small" onclick="ocultarDetallePrestamo()">‚úï Cerrar</button>
                    </div>
                    <div class="card-body">
                        <div id="detalle-prestamo-info"></div>
                        <h4 style="margin-top: 20px;">Cronograma de Cuotas</h4>
                        <table class="tabla-clientes">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Vencimiento</th>
                                    <th>Monto</th>
                                    <th>Saldo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-cuotas"></tbody>
                        </table>
                    </div>
                </div>

                <!-- MODAL HISTORIAL DE PAGOS (NUEVO) -->
                <div id="modal-historial"
                    style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                    <div
                        style="background: white; width: 90%; max-width: 600px; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">üìú Historial de Pagos - Cuota <span id="historial-num-cuota"></span>
                            </h3>
                            <button onclick="cerrarHistorial()"
                                style="background: none; border: none; font-size: 1.5em; cursor: pointer;">‚úï</button>
                        </div>

                        <div id="historial-lista" style="max-height: 400px; overflow-y: auto;">
                            <!-- Aqu√≠ se cargar√°n los pagos -->
                            <p style="text-align: center; color: #666;">Cargando...</p>
                        </div>

                        <div style="text-align: right; margin-top: 15px;">
                            <button class="btn-secondary" onclick="cerrarHistorial()">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN PAGOS / COBRANZA -->
            <div id="seccion-pagos" class="seccion" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h3>üí≥ Registrar Pago</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Buscar Cliente por DNI o Nombre:</label>
                            <div class="input-group">
                                <input type="text" id="buscar-pago-doc"
                                    placeholder="Ingrese DNI, RUC o Nombre del Cliente">
                                <button class="btn-secondary" onclick="buscarClienteParaPago()">üîç Buscar
                                    Pr√©stamo</button>
                            </div>
                        </div>

                        <div id="info-pago-cliente" style="display:none;">
                            <div style="padding: 15px; background: #e3f2fd; border-radius: 5px; margin-bottom: 15px;">
                                <p style="margin: 5px 0;"><strong>Cliente:</strong> <span
                                        id="pago-cliente-nombre"></span></p>
                                <p style="margin: 5px 0;"><strong>Pr√©stamo:</strong> S/ <span
                                        id="pago-monto-total"></span> en <span id="pago-num-cuotas"></span> cuotas</p>
                            </div>

                            <div class="form-group">
                                <label>Seleccionar Cuota:</label>
                                <select id="select-cuota" onchange="seleccionarCuota()">
                                    <option value="">-- Seleccione una cuota --</option>
                                </select>
                            </div>

                            <div id="detalle-cuota" style="display:none;">
                                <!-- DESGLOSE MEJORADO DEL PAGO -->
                                <div
                                    style="padding: 15px; background: #fff3e0; border-radius: 5px; margin-bottom: 15px;">
                                    <h4 style="margin-top: 0; color: #f57c00;">üí∞ Desglose del Pago</h4>

                                    <div
                                        style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ddd;">
                                        <span><strong>Monto Capital:</strong></span>
                                        <span id="cuota-monto-capital" style="font-size: 1.1em;">S/ 0.00</span>
                                    </div>

                                    <div id="linea-mora"
                                        style="display: none; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ddd;">
                                        <span style="color: #e74c3c;"><strong>‚ö†Ô∏è Mora (1%):</strong></span>
                                        <span id="cuota-mora-monto" style="color: #e74c3c; font-weight: bold;">S/
                                            0.00</span>
                                    </div>

                                    <div
                                        style="display: flex; justify-content: space-between; padding: 12px 0; background: #f9f9f9; margin: 10px -15px; padding-left: 15px; padding-right: 15px;">
                                        <span style="font-size: 1.2em;"><strong>TOTAL A PAGAR:</strong></span>
                                        <span id="cuota-total-pagar"
                                            style="font-size: 1.3em; font-weight: bold; color: #27ae60;">S/ 0.00</span>
                                    </div>

                                    <div
                                        style="margin-top: 10px; padding: 8px; background: #e8f5e9; border-radius: 4px;">
                                        <p style="margin: 5px 0;"><strong>Saldo Pendiente:</strong> S/ <span
                                                id="cuota-saldo"></span></p>
                                        <p style="margin: 5px 0;"><strong>Vencimiento:</strong> <span
                                                id="cuota-vencimiento"></span></p>
                                        <p style="margin: 5px 0; font-weight: bold;" id="cuota-dias-atraso"></p>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Monto a Pagar:</label>
                                    <input type="number" id="monto-pagar" placeholder="Ingrese monto" step="0.01"
                                        onchange="actualizarRedondeo()">
                                    <small id="mensaje-redondeo"
                                        style="color: #f57c00; font-weight: bold; display: none;"></small>
                                </div>

                                <div class="form-group">
                                    <label>Medio de Pago:</label>
                                    <select id="medio-pago" onchange="actualizarRedondeo()">
                                        <option value="EFECTIVO">üíµ Efectivo (con redondeo)</option>
                                        <option value="YAPE">üì± Yape (cobro exacto)</option>
                                        <option value="PLIN">üì± Plin (cobro exacto)</option>
                                        <option value="TARJETA">üí≥ Tarjeta (cobro exacto)</option>
                                    </select>
                                </div>

                                <button class="btn-secondary" style="width: 100%; padding: 12px;"
                                    onclick="procesarPago()">
                                    üí≥ Procesar Pago
                                </button>
                            </div>
                        </div>

                        <div id="mensaje-pago" class="mensaje"></div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN CAJA -->
            <div id="seccion-caja" class="seccion" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h3>üè¶ Control de Caja</h3>
                    </div>
                    <div class="card-body">

                        <!-- Caja Cerrada -->
                        <div id="caja-cerrada" style="text-align: center; padding: 20px;">
                            <h3>üî¥ La Caja est√° Cerrada</h3>
                            <p>Debe abrir caja para poder procesar cobros.</p>

                            <div class="form-group" style="max-width: 300px; margin: 20px auto;">
                                <label>Monto Inicial (S/):</label>
                                <input type="number" id="monto-inicial-caja" value="0.00">
                            </div>

                            <button class="btn-secondary" onclick="abrirCaja()">
                                üîì Abrir Caja
                            </button>
                        </div>

                        <!-- Caja Abierta -->
                        <div id="caja-abierta" style="display: none;">
                            <div
                                style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 5px solid #27ae60; margin-bottom: 20px;">
                                <h3 style="margin-top:0; color: #2e7d32;">‚úÖ Caja Abierta</h3>
                                <p id="info-apertura"></p>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="card" style="background: #f8f9fa;">
                                    <div class="card-body">
                                        <h4 style="border-bottom: 2px solid #ddd; padding-bottom: 5px;">üìä Reporte de
                                            Turno</h4>
                                        <table style="width: 100%; border-collapse: separate; border-spacing: 0 5px;">
                                            <tr>
                                                <td><strong>Fondo Inicial:</strong></td>
                                                <td style="text-align: right;">S/ <span id="resumen-inicial">0.00</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="2">
                                                    <hr style="margin: 5px 0; border: 0; border-top: 1px dashed #ccc;">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="2" style="color: #2c3e50;"><strong>INGRESOS (Ventas del
                                                        D√≠a)</strong></td>
                                            </tr>
                                            <tr>
                                                <td style="padding-left: 10px;">üíµ Efectivo Cobrado:</td>
                                                <td style="text-align: right;">S/ <span
                                                        id="resumen-efectivo">0.00</span></td>
                                            </tr>
                                            <tr>
                                                <td style="padding-left: 10px;">üì± Yape/Plin (Banco):</td>
                                                <td style="text-align: right;">S/ <span id="resumen-digital">0.00</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding-left: 10px;">üí≥ Tarjeta (Banco):</td>
                                                <td style="text-align: right;">S/ <span id="resumen-tarjeta">0.00</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="2">
                                                    <hr
                                                        style="margin: 5px 0; border: 0; border-top: 2px solid #2c3e50;">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="color: #e67e22;"><strong>CUADRE DE EFECTIVO</strong></td>
                                                <td></td>
                                            </tr>
                                            <tr>
                                                <td style="font-size: 0.9em;">(Inicial + Efectivo Cobrado)</td>
                                                <td></td>
                                            </tr>
                                            <tr style="background-color: #ffe0b2; font-weight: bold;">
                                                <td style="padding: 5px;">üí∞ DEBE HABER EN CAJ√ìN:</td>
                                                <td style="text-align: right; padding: 5px; font-size: 1.2em;">S/ <span
                                                        id="resumen-total-cajon">0.00</span></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>

                                <div class="card" style="background: #fff3e0;">
                                    <div class="card-body">
                                        <h4>Arqueo / Cierre</h4>
                                        <div class="form-group">
                                            <label>Monto Real en Efectivo (Contado):</label>
                                            <input type="number" id="monto-real-cierre"
                                                placeholder="¬øCu√°nto dinero tienes f√≠sicamente?">
                                        </div>
                                        <button class="btn-secondary" style="width: 100%; background: #e67e22;"
                                            onclick="cerrarCaja()">
                                            üîí Cerrar Caja y Arquear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="mensaje-caja" class="mensaje"></div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN EMPLEADOS -->
            <div id="seccion-empleados" class="seccion" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h3>üë• Gesti√≥n de Empleados</h3>
                        <button class="btn-small" onclick="cargarEmpleados()">üîÑ Actualizar</button>
                    </div>
                    <div class="card-body">

                        <!-- Formulario Nuevo Empleado -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4>Nuevo Empleado</h4>
                            <div class="input-group" style="margin-bottom: 10px;">
                                <input type="text" id="emp-nombre" placeholder="Nombre completo">
                                <input type="text" id="emp-usuario" placeholder="Usuario (Login)">
                            </div>
                            <div class="input-group">
                                <input type="password" id="emp-password" placeholder="Contrase√±a">
                                <select id="emp-rol">
                                    <option value="CAJERO">Cajero</option>
                                    <option value="ADMIN">Administrador</option>
                                </select>
                                <button class="btn-secondary" onclick="crearEmpleado()">‚ûï Crear</button>
                            </div>
                            <div id="mensaje-empleado" class="mensaje"></div>
                        </div>

                        <!-- Lista de Empleados -->
                        <table class="tabla-clientes">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Usuario</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="listaEmpleados"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Script Principal -->
    <script src="App.js"></script>
</body>

</html>