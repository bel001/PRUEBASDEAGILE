<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agile Pr√©stamos - Sistema de Cobranzas</title>
    <link rel="stylesheet" href="Style.css">
    <!-- jsPDF para generar comprobantes PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="toast-container"></div>

    <!-- PANTALLA DE LOGIN -->
    <div id="pantalla-login" class="login-overlay" style="display: flex;">
        <div class="login-card">
            <h1>üè¶ AGILE Pr√©stamos</h1>
            <h3>Sistema de Cobranzas</h3>
            <p style="color: #7f8c8d; margin-bottom: 30px;">Inicio de Sesi√≥n</p>

            <div class="form-group">
                <label>Usuario:</label>
                <input type="text" id="login-usuario" placeholder="Ingrese su usuario">
            </div>

            <div class="form-group">
                <label>Contrase√±a:</label>
                <input type="password" id="login-password" placeholder="Ingrese su contrase√±a">
            </div>

            <div id="login-mensaje" style="color: #e74c3c; text-align: center; margin: 10px 0;"></div>

            <button class="btn-secondary" style="width: 100%; padding: 12px;" onclick="iniciarSesion()">
                üîê Iniciar Sesi√≥n
            </button>
        </div>
    </div>

    <!-- APLICACI√ìN PRINCIPAL -->
    <div id="app-principal" class="app-layout" style="display: none;">

        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="Agile Prestamos" style="width: 100%; max-width: 150px; margin-bottom: 10px;">
                <h2 style="font-size: 1.2em;">AGILE-PRESTAMOS</h2>
            </div>

            <nav class="sidebar-nav">
                <button class="nav-item" onclick="mostrarSeccion('clientes')">
                    <span class="nav-icon">üë•</span>
                    <span>Clientes</span>
                </button>
                <button class="nav-item" onclick="mostrarSeccion('prestamos')">
                    <span class="nav-icon">üíµ</span>
                    <span>Pr√©stamos</span>
                </button>
                <button class="nav-item" onclick="mostrarSeccion('pagos')">
                    <span class="nav-icon">üí≥</span>
                    <span>Cobranza</span>
                </button>
                <button class="nav-item" onclick="mostrarCaja()">
                    <span class="nav-icon">üè¶</span>
                    <span>Caja</span>
                </button>
                <button class="nav-item btn-admin" onclick="mostrarSeccion('config')">
                    <span class="nav-icon">‚öô</span>
                    <span>Configuraci√≥n</span>
                </button>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">C</div>
                    <div>
                        <div class="user-name" id="sidebar-user-name">Cajero</div>
                        <div class="user-role" id="sidebar-user-role">Operador</div>
                    </div>
                </div>
                <button class="btn-logout" onclick="cerrarSesion()">üö™ Cerrar Sesi√≥n</button>
            </div>
        </aside>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="main-content">
            <!-- HEADER -->
            <div class="content-header">
                <h1 id="page-title">Dashboard</h1>
                <div class="header-actions">
                    <!-- Fecha -->
                    <span class="header-date" id="header-date"></span>
                </div>
            </div>

            <!-- SECCI√ìN CLIENTES -->
            <div id="seccion-clientes" class="seccion">
                <!-- Estad√≠sticas de Filtro (Oculto por defecto) -->
                <div id="stats-morosos" class="filter-stats" style="display: none;">
                    <span>‚ö† Mostrando solo clientes con cuotas vencidas</span>
                    <span id="total-mora-acumulada">Total Mora: S/ 0.00</span>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>‚ûï Registrar Nuevo Cliente</h3>
                    </div>
                    <div class="card-body">
                        <!-- Fila 1: Tipo y N√∫mero de Documento -->
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Tipo de Documento: <span class="required">*</span></label>
                                <select id="tipo" onchange="actualizarMaxLengthDocumento()">
                                    <option value="DNI">DNI (8 d√≠gitos)</option>
                                    <option value="RUC">RUC (11 d√≠gitos)</option>
                                    <option value="PASAPORTE">Pasaporte</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <label>N√∫mero de Documento: <span class="required">*</span></label>
                                <div class="input-group">
                                    <input type="text" id="documento" placeholder="Ingrese el n√∫mero" maxlength="8"
                                        oninput="validarDocumento()" onblur="buscarDatosCliente()">
                                    <button type="button" class="btn-small" onclick="buscarDatosCliente()"
                                        style="margin-left: 5px; padding: 8px 15px;">
                                        üîç Buscar Datos
                                    </button>
                                    <span id="doc-validacion" class="validation-icon"></span>
                                </div>
                                <small id="doc-mensaje">DNI debe tener exactamente 8 d√≠gitos.</small>
                            </div>
                        </div>

                        <!-- Check Persona Jur√≠dica -->
                        <div class="form-group" style="margin-top: 10px; margin-bottom: 5px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="check-juridica" onchange="toggleJuridica()"
                                    style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="check-juridica"
                                    style="margin: 0; cursor: pointer; font-weight: bold; color: var(--dark);">
                                    Es Persona Jur√≠dica / Ente Jur√≠dico
                                </label>
                            </div>
                        </div>

                        <!-- Secci√≥n Declaraci√≥n Jurada (Oculta) -->
                        <div id="seccion-juridica"
                            style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 5px solid #ffc107; margin-top: 5px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #856404; font-size: 16px;">‚ö† Requisito para Personas
                                Jur√≠dicas</h4>

                            <div class="form-group">
                                <label style="font-weight: bold; display: block; margin-bottom: 5px;">1. Descargar
                                    Plantilla:</label>
                                <!-- Plantilla en Nube (Firebase Storage) -->
                                <a id="link-plantilla-dj"
                                    href="https://firebasestorage.googleapis.com/v0/b/agile-prestamos.firebasestorage.app/o/plantillas%2FMODELO_DECLARACION_JURADA.pdf?alt=media&token=b3f7db6c-d060-44ba-9952-6cd043b32456"
                                    target="_blank" class="btn-small"
                                    style="background: #e74c3c; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; color: white; padding: 8px 15px; border-radius: 5px;">
                                    üìÑ Ver Modelo de Declaraci√≥n Jurada
                                </a>
                                <small style="display: block; margin-top: 5px; color: #666;">Descargue este formato,
                                    f√≠rmelo y luego s√∫balo en la opci√≥n de abajo.</small>
                            </div>

                            <hr style="border: 0; border-top: 1px solid #e0d0a0; margin: 15px 0;">

                            <div class="form-group">
                                <label style="font-weight: bold;">2. Subir Declaraci√≥n Jurada Firmada:</label>
                                <input type="file" id="archivo-dj" accept=".pdf"
                                    style="background: white; padding: 10px; border-radius: 5px; width: 100%;">
                                <small>Solo se permiten archivos PDF.</small>
                            </div>
                        </div>

                        <!-- Fila 2: Nombre Completo -->
                        <div class="form-group">
                            <label>Nombre Completo / Raz√≥n Social: <span class="required">*</span></label>
                            <input type="text" id="nombre" placeholder="Nombres y Apellidos completos">
                        </div>

                        <!-- Fila 3: Direcci√≥n -->
                        <div class="form-group">
                            <label>Direcci√≥n: <span class="required">*</span></label>
                            <input type="text" id="direccion" placeholder="Av. / Jr. / Calle, Nro, Distrito">
                        </div>

                        <!-- Fila 4: Tel√©fono y Email -->
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Celular / WhatsApp: <span class="required">*</span></label>
                                <div class="input-group">
                                    <span
                                        style="padding: 10px; background: var(--border); border-radius: 8px 0 0 8px;">+51</span>
                                    <input type="tel" id="telefono" placeholder="987654321" maxlength="9"
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                                </div>
                                <small>9 d√≠gitos, sin espacios ni guiones.</small>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Correo Electr√≥nico:</label>
                                <input type="email" id="email" placeholder="cliente@correo.com">
                                <small>Opcional, para env√≠o de comprobantes.</small>
                            </div>
                        </div>

                        <!-- Bot√≥n de Registro -->
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn-primary" onclick="crearCliente()">üíæ Registrar Cliente</button>
                            <button class="btn-secondary" onclick="limpiarFormularioCliente()">üßπ Limpiar</button>
                        </div>

                        <div id="mensaje" class="mensaje" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>üìã Listado de Clientes</h3>
                        <button id="btn-filtro-morosos" class="btn-filter" onclick="toggleFiltroMorosos()">
                            ‚ö† Ver Solo Morosos
                        </button>
                        <button class="btn-small" onclick="cargarClientes()" style="margin-left: 10px;">üîÑ
                            Actualizar</button>
                        <button class="btn-small" onclick="exportarClientesCSV()"
                            style="margin-left: 10px; background: #27ae60;">üì• Exportar CSV</button>
                    </div>
                    <div class="card-body">
                        <table class="tabla-clientes">
                            <thead>
                                <tr>
                                    <th>Documento</th>
                                    <th>Nombre / Raz√≥n Social</th>
                                    <th>Tipo</th>
                                    <th>Condici√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="listaClientes">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN PR√âSTAMOS -->
            <div id="seccion-prestamos" class="seccion" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h3>Nuevo Pr√©stamo</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Buscar Cliente por Documento o Nombre:</label>
                            <div class="input-group">
                                <input type="text" id="buscar-cliente-doc" placeholder="Ingrese DNI, RUC o Nombre">
                                <button class="btn-secondary" onclick="buscarClienteParaPrestamo()">üîç Buscar</button>
                            </div>
                        </div>

                        <div id="info-cliente"
                            style="display:none; padding: 15px; background: #e8f5e9; border-radius: 5px; margin-bottom: 15px;">
                            <p style="margin: 5px 0;"><strong>Cliente:</strong> <span id="cliente-nombre"></span></p>
                            <p style="margin: 5px 0;"><strong>Documento:</strong> <span id="cliente-doc"></span></p>
                        </div>

                        <div id="form-prestamo" style="display:none;">
                            <div class="form-group">
                                <label>Monto del Pr√©stamo (Capital):</label>
                                <input type="number" id="monto-capital" placeholder="Ej: 1000" step="0.01" max="20000">
                                <small>M√°ximo: S/ 20,000</small>
                            </div>

                            <div class="form-group">
                                <label>Fecha de Inicio:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="date" id="fecha-inicio-prestamo" style="flex: 1;">
                                    <button class="btn-small" onclick="setFechaHoyPrestamo()" type="button">üìÖ
                                        Hoy</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>TEA (%):</label>
                                <input type="number" id="tea-prestamo" placeholder="Ej: 85.5" step="0.01">
                                <small>Tasa Efectiva Anual</small>
                            </div>

                            <div class="form-group">
                                <label>N√∫mero de Cuotas:</label>
                                <input type="number" id="num-cuotas" placeholder="Ej: 12" min="1" max="24">
                                <small>M√°ximo: 24 cuotas</small>
                            </div>

                            <button class="btn-secondary" style="width: 100%; padding: 12px;" onclick="crearPrestamo()">
                                üí∞ Crear Pr√©stamo
                            </button>
                        </div>

                        <div id="mensaje-prestamo" class="mensaje"></div>
                    </div>
                </div>

                <div class="card" id="detalle-prestamo-card" style="display:none;">
                    <div class="card-header">
                        <h3>Pr√©stamo Activo</h3>
                        <button class="btn-small" onclick="ocultarDetallePrestamo()">‚úï Cerrar</button>
                    </div>
                    <div class="card-body">
                        <div id="detalle-prestamo-info"></div>
                        <h4 style="margin-top: 20px;">Cronograma de Cuotas</h4>
                        <table class="tabla-clientes">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Vencimiento</th>
                                    <th>Saldo Capital</th>
                                    <th>Amortizaci√≥n</th>
                                    <th>Inter√©s</th>
                                    <th>Cuota</th>
                                    <th>Deuda Cuota</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-cuotas"></tbody>
                        </table>
                    </div>
                </div>

                <!-- MODAL HISTORIAL DE PAGOS (NUEVO) -->
                <div id="modal-historial"
                    style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                    <div
                        style="background: white; width: 90%; max-width: 600px; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">üìú Historial de Pagos - Cuota <span id="historial-num-cuota"></span>
                            </h3>
                            <button onclick="cerrarHistorial()"
                                style="background: none; border: none; font-size: 1.5em; cursor: pointer;">‚úï</button>
                        </div>

                        <div id="historial-lista" style="max-height: 400px; overflow-y: auto;">
                            <!-- Aqu√≠ se cargar√°n los pagos -->
                            <p style="text-align: center; color: #666;">Cargando...</p>
                        </div>

                        <div style="text-align: right; margin-top: 15px;">
                            <button class="btn-secondary" onclick="cerrarHistorial()">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL ESTADO DE CUENTA (NUEVO) -->
            <div id="modal-estado-cuenta"
                style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                <div
                    style="background: white; width: 95%; max-width: 800px; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                        <h3 style="margin: 0;">üìã Estado de Cuenta - <span id="estado-cuenta-cliente">Cliente</span>
                        </h3>
                        <button onclick="cerrarEstadoCuenta()"
                            style="background: none; border: none; font-size: 1.5em; cursor: pointer;">‚úï</button>
                    </div>

                    <div id="estado-cuenta-resumen"
                        style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <!-- Resumen din√°mico -->
                    </div>

                    <table class="tabla-clientes" id="tabla-estado-cuenta" style="display:none;">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cuota #</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Detalle</th>
                            </tr>
                        </thead>
                        <tbody id="estado-cuenta-lista">
                            <!-- Filas din√°micas -->
                        </tbody>
                    </table>

                    <div style="margin-top: 30px; border-top: 2px solid #3498db; padding-top: 10px;">
                        <h4 style="color: #2c3e50;">üìú Historial de Transacciones (Detallado)</h4>
                        <table class="tabla-clientes">
                            <thead>
                                <tr style="background: #e1f5fe;">
                                    <th>Fecha Pago</th>
                                    <th>Cuota Asoc.</th>
                                    <th>Monto Pagado</th>
                                    <th>Medio</th>
                                    <th>Recibo</th>
                                </tr>
                            </thead>
                            <tbody id="estado-cuenta-pagos-lista">
                                <!-- Pagos parciales y totales aqu√≠ -->
                            </tbody>
                        </table>
                    </div>

                    <div style="text-align: right; margin-top: 15px;">
                        <button class="btn-secondary" onclick="cerrarEstadoCuenta()">Cerrar</button>
                    </div>
                </div>
            </div>

            <!-- MODAL DETALLE CLIENTE (NUEVO) -->
            <div id="modal-detalle-cliente"
                style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                <div
                    style="background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <h3 style="margin: 0; color: #2c3e50;">üë§ Datos del Cliente</h3>
                        <button onclick="cerrarModalCliente()"
                            style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #7f8c8d;">‚úï</button>
                    </div>

                    <div id="detalle-cliente-contenido" style="font-size: 1.05em; line-height: 1.6;">
                        <!-- Contenido din√°mico -->
                    </div>

                    <div style="text-align: right; margin-top: 25px;">
                        <button class="btn-primary" onclick="cerrarModalCliente()">Cerrar</button>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN PAGOS / COBRANZA -->
            <div id="seccion-pagos" class="seccion" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h3>üí≥ Registrar Pago</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Buscar Cliente por DNI o Nombre:</label>
                            <div class="input-group">
                                <input type="text" id="buscar-pago-doc"
                                    placeholder="Ingrese DNI, RUC o Nombre del Cliente">
                                <button class="btn-secondary" onclick="buscarClienteParaPago()">üîç Buscar
                                    Pr√©stamo</button>
                            </div>
                        </div>

                        <div id="info-pago-cliente" style="display:none;">
                            <div style="padding: 15px; background: #e3f2fd; border-radius: 5px; margin-bottom: 15px;">
                                <p style="margin: 5px 0;"><strong>Cliente:</strong> <span
                                        id="pago-cliente-nombre"></span></p>
                                <p style="margin: 5px 0;"><strong>Pr√©stamo:</strong> S/ <span
                                        id="pago-monto-total"></span> en <span id="pago-num-cuotas"></span> cuotas</p>
                                <p style="margin: 5px 0;"><strong>Estado:</strong> <span
                                        id="pago-estado-prestamo">-</span></p>
                                <p style="margin: 5px 0;"><strong>Saldo restante:</strong> S/ <span
                                        id="pago-saldo-restante">0.00</span></p>
                                <div id="panel-estado-prestamo" style="margin-top: 10px; display: none;">
                                    <div style="font-size: 0.9em; color: #2c3e50; margin-bottom: 6px;"><strong>Historial
                                            de pagos (?ltimos):</strong></div>
                                    <div id="lista-pagos-prestamo"
                                        style="max-height: 120px; overflow-y: auto; font-size: 0.9em; background: #fff; padding: 8px; border-radius: 6px; border: 1px solid #dfe6e9;">
                                        <em>Sin pagos registrados</em>
                                    </div>
                                </div>

                                <button class="btn-small" style="background: #3498db; margin-top: 10px;"
                                    onclick="verEstadoCuenta()">
                                    üìã Ver Estado de Cuenta Completo
                                </button>
                            </div>

                            <div class="form-group">
                                <label>Seleccionar Cuota:</label>
                                <select id="select-cuota" onchange="seleccionarCuota()">
                                    <option value="">-- Seleccione una cuota --</option>
                                </select>
                            </div>

                            <div id="detalle-cuota" style="display:none;">
                                <!-- DESGLOSE MEJORADO DEL PAGO -->
                                <div
                                    style="padding: 15px; background: #fff3e0; border-radius: 5px; margin-bottom: 15px;">
                                    <h4 style="margin-top: 0; color: #f57c00;">üí∞ Desglose del Pago</h4>

                                    <div
                                        style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ddd;">
                                        <span><strong>Monto Capital:</strong></span>
                                        <span id="cuota-monto-capital" style="font-size: 1.1em;">S/ 0.00</span>
                                    </div>

                                    <div id="linea-mora"
                                        style="display: none; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ddd;">
                                        <span style="color: #e74c3c;"><strong>‚ö† Mora (1%):</strong></span>
                                        <span id="cuota-mora-monto" style="color: #e74c3c; font-weight: bold;">S/
                                            0.00</span>
                                    </div>

                                    <div
                                        style="display: flex; justify-content: space-between; padding: 12px 0; background: #f9f9f9; margin: 10px -15px; padding-left: 15px; padding-right: 15px;">
                                        <span style="font-size: 1.2em;"><strong>TOTAL A PAGAR:</strong></span>
                                        <span id="cuota-total-pagar"
                                            style="font-size: 1.3em; font-weight: bold; color: #27ae60;">S/ 0.00</span>
                                    </div>

                                    <div
                                        style="margin-top: 10px; padding: 8px; background: #e8f5e9; border-radius: 4px;">
                                        <p style="margin: 5px 0;"><strong>Saldo Pendiente:</strong> S/ <span
                                                id="cuota-saldo"></span></p>
                                        <p style="margin: 5px 0;"><strong>Vencimiento:</strong> <span
                                                id="cuota-vencimiento"></span></p>
                                        <p style="margin: 5px 0; font-weight: bold;" id="cuota-dias-atraso"></p>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Monto a Pagar:</label>
                                    <input type="number" id="monto-pagar" placeholder="Ingrese monto" step="0.01"
                                        onchange="actualizarRedondeo()">
                                    <small id="mensaje-redondeo"
                                        style="color: #f57c00; font-weight: bold; display: none;"></small>
                                </div>

                                <select id="medio-pago" onchange="actualizarRedondeo()">
                                    <option value="EFECTIVO">üíµ Efectivo (con redondeo)</option>
                                    <option value="FLOW">üîµ Flow (Link de Pago)</option>
                                </select>
                            </div>

                            <!-- SECCI√ìN EFECTIVO (Visible solo si es efectivo) -->
                            <div id="seccion-pago-efectivo"
                                style="display:none; background: #e8f5e9; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label>üíµ Efectivo Entregado:</label>
                                    <input type="number" id="monto-efectivo-entregado" placeholder="Monto recibido"
                                        step="0.01" oninput="calcularVueltoUI()">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: bold; color: #2e7d32;">üí∞ Vuelto a Entregar:</span>
                                    <span id="texto-vuelto"
                                        style="font-size: 1.4em; font-weight: bold; color: #2e7d32;">S/ 0.00</span>
                                </div>
                            </div>

                            <button class="btn-secondary" style="width: 100%; padding: 12px;" onclick="procesarPago()">
                                üí≥ Procesar Pago
                            </button>
                        </div>
                    </div>

                    <div id="mensaje-pago" class="mensaje"></div>
                </div>
            </div>

            <!-- SECCI√ìN CAJA -->
            <div id="seccion-caja" class="seccion" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h3>üè¶ Control de Caja</h3>
                    </div>
                    <div class="card-body">
                        <!-- Caja Cerrada -->
                        <div id="caja-cerrada" style="text-align: center; padding: 20px;">
                            <h3>üî¥ La Caja est√° Cerrada</h3>
                            <p>Debe abrir caja para poder procesar cobros.</p>

                            <div class="form-group" style="max-width: 300px; margin: 20px auto;">
                                <label>Monto Inicial (S/):</label>
                                <input type="number" id="monto-inicial-caja" value="0.00">
                            </div>

                            <button class="btn-secondary" onclick="abrirCaja()">
                                üîì Abrir Caja
                            </button>
                        </div>

                        <!-- Caja Abierta -->
                        <div id="caja-abierta" style="display: none;">
                            <div
                                style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 5px solid #27ae60; margin-bottom: 20px;">
                                <h3 style="margin-top:0; color: #2e7d32;">‚úÖ Caja Abierta</h3>
                                <p id="info-apertura"></p>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="card" style="background: #f8f9fa;">
                                    <div class="card-body">
                                        <h4 style="border-bottom: 2px solid #ddd; padding-bottom: 5px;">üìä Reporte de
                                            Turno</h4>
                                        <table style="width: 100%; border-collapse: separate; border-spacing: 0 10px;">
                                            <!-- Fila oculta para compatibilidad JS -->
                                            <tr style="display:none;">
                                                <td><span id="resumen-total-cajon">0.00</span></td>
                                            </tr>

                                            <tr>
                                                <td style="padding: 10px; color: #7f8c8d;">üè¶ Fondo en Caja:</td>
                                                <td
                                                    style="text-align: right; padding: 10px; font-weight: bold; color: #7f8c8d;">
                                                    S/ <span id="resumen-inicial">0.00</span>
                                                </td>
                                            </tr>

                                            <tr style="background-color: #fff3e0;">
                                                <td style="padding: 10px; border-radius: 5px 0 0 5px; color: #e65100;">
                                                    üíµ Ventas Efectivo:</td>
                                                <td
                                                    style="text-align: right; padding: 10px; font-weight: bold; border-radius: 0 5px 5px 0; color: #e65100;">
                                                    S/ <span id="resumen-efectivo">0.00</span>
                                                </td>
                                            </tr>

                                            <tr>
                                                <td style="padding: 10px; color: #2c3e50;">üí≥ Digital (Flow):</td>
                                                <td
                                                    style="text-align: right; padding: 10px; font-weight: bold; color: #2c3e50;">
                                                    S/ <span id="resumen-flow">0.00</span>
                                                </td>
                                            </tr>

                                            <tr>
                                                <td colspan="2">
                                                    <hr style="margin: 0; border: 0; border-top: 2px solid #aaa;">
                                                </td>
                                            </tr>

                                            <tr style="background-color: #dcedc8;">
                                                <td style="padding: 10px; border-radius: 5px 0 0 5px; color: #1b5e20;">
                                                    <strong>üìà TOTAL EN EFECTIVO:</strong>
                                                </td>
                                                <td
                                                    style="text-align: right; padding: 10px; font-weight: bold; font-size: 1.3em; color: #1b5e20; border-radius: 0 5px 5px 0;">
                                                    S/ <span id="resumen-total-general">0.00</span>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>

                                <div class="card" style="background: #fff3e0;">
                                    <div class="card-body">
                                        <h4>Arqueo / Cierre</h4>
                                        <div class="form-group">
                                            <label>Dinero Recaudado en el D√≠a:</label>
                                            <input type="number" id="monto-real-cierre"
                                                placeholder="Cuanto dinero recaudaste al dia">
                                        </div>
                                        <button class="btn-secondary" style="width: 100%; background: #e67e22;"
                                            onclick="cerrarCaja()">
                                            üîí Cerrar Caja y Arquear
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- NUEVA SECCION: Historial de Efectivo -->
                            <div class="card" style="margin-top: 20px; grid-column: 1 / -1;">
                                <div class="card-header" style="background: #f1f8e9; border-bottom: 2px solid #8bc34a;">
                                    <h4 style="margin: 0; color: #33691e;">üìú Historial de Movimientos de Efectivo
                                        (Sesi√≥n Actual)</h4>
                                    <button class="btn-small" onclick="cargarHistorialCaja()"
                                        style="background: #aed581; color: #1b5e20;">üîÑ Actualizar</button>
                                </div>
                                <div class="card-body" style="padding: 0;">
                                    <table class="tabla-clientes" style="width: 100%; margin: 0;">
                                        <thead>
                                            <tr style="background: #dcedc8;">
                                                <th>Hora</th>
                                                <th>Descripci√≥n</th>
                                                <th>Tipo</th>
                                                <th style="text-align: right;">Monto</th>
                                            </tr>
                                        </thead>
                                        <tbody id="lista-movimientos-caja">
                                            <tr>
                                                <td colspan="4" style="text-align:center; padding: 15px;">Cargando...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div id="mensaje-caja" class="mensaje"></div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN CONFIGURACI√ìN -->
            <div id="seccion-config" class="seccion" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h3>‚öô Configuraci√≥n del Sistema</h3>
                    </div>
                    <div class="card-body">



                        <!-- Simulaci√≥n de Fecha -->
                        <div
                            style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #e67e22;">
                            <h4 style="margin-top: 0;">üìÖ Simulaci√≥n de Fecha (Sistema)</h4>
                            <p style="margin: 0 0 10px 0; color: #d35400; font-size: 0.9em;">
                                ‚ö† Afecta Caja y Mora.
                            </p>
                            <div class="form-group" style="margin-bottom: 0;">
                                <div class="input-group"
                                    style="max-width: 350px; display: flex; gap: 10px; align-items: center;">
                                    <input type="date" id="config-fecha-sistema" class="form-control" style="flex: 1;">
                                    <button class="btn-primary" onclick="guardarFechaSistema()"
                                        style="background: #e67e22; border: none; padding: 8px 15px; white-space: nowrap;">
                                        üíæ Cambiar
                                    </button>
                                </div>
                                <small style="display: block; margin-top: 5px; color: #666;">
                                    Actual: <span id="fecha-servidor-actual"
                                        style="font-weight:bold; color: #333;">...</span>
                                </small>
                            </div>
                        </div>

                        <!-- Info del Sistema -->
                        <div style="background: #e8f4fd; padding: 20px; border-radius: 8px;">
                            <h4>‚Ñπ Informaci√≥n del Sistema</h4>
                            <p><strong>Versi√≥n:</strong> 2.0 - AGILE Pr√©stamos</p>
                            <p><strong>Servidor:</strong> <span id="config-servidor-url">-</span></p>
                            <p><strong>Usuario Actual:</strong> <span id="config-usuario-actual">-</span></p>
                            <p><strong>Rol:</strong> <span id="config-rol-actual">-</span></p>
                        </div>

                        <div id="mensaje-config" class="mensaje" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Script Principal -->
    <script src="App.js"></script>
</body>

</html>